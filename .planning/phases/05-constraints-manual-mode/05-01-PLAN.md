---
phase: 05-constraints-manual-mode
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - flowplan/src/types/entities.ts
  - flowplan/src/services/scheduling.ts
  - flowplan/src/services/scheduling.test.ts
  - flowplan/supabase/migrations/007_add_constraints_manual_mode.sql
autonomous: true

must_haves:
  truths:
    - "MSO constraint sets task ES to constraint date when no dependency pushes later"
    - "MSO constraint is overridden when dependency pushes ES later than constraint date"
    - "SNET constraint uses the later of dependency ES and SNET date"
    - "FNLT violation detected when computed EF exceeds constraint date"
    - "Manual tasks preserve user-set start_date/end_date as ES/EF in forward pass"
    - "Manual tasks are skipped in forward/backward pass computation but contribute dates for successor calculations"
    - "ASAP constraint and null constraint behave identically in the engine"
  artifacts:
    - path: "flowplan/src/types/entities.ts"
      provides: "ConstraintType and SchedulingMode type definitions, updated Task interface"
      contains: "ConstraintType"
    - path: "flowplan/src/services/scheduling.ts"
      provides: "Forward/backward pass with constraint integration and manual task skip"
      contains: "constraint_type"
    - path: "flowplan/src/services/scheduling.test.ts"
      provides: "Test coverage for all constraint types and manual mode in CPM engine"
      contains: "MSO constraint"
    - path: "flowplan/supabase/migrations/007_add_constraints_manual_mode.sql"
      provides: "Database columns for constraint_type, constraint_date, scheduling_mode"
      contains: "ALTER TABLE tasks"
  key_links:
    - from: "flowplan/src/services/scheduling.ts"
      to: "flowplan/src/types/entities.ts"
      via: "Task interface with constraint_type, constraint_date, scheduling_mode fields"
      pattern: "task\\.constraint_type"
    - from: "flowplan/src/services/scheduling.ts"
      to: "flowplan/src/services/scheduling.test.ts"
      via: "Test cases validate constraint and manual mode behavior"
      pattern: "scheduling_mode.*manual"
---

<objective>
Add constraint types (ASAP/MSO/SNET/FNLT) and manual scheduling mode to the CPM engine using TDD.

Purpose: The scheduling engine is the algorithmic foundation. Constraints and manual mode must be correct before wiring to services, hooks, or UI. This plan adds type definitions, database columns, and engine logic with comprehensive test coverage.

Output: Updated entities.ts with constraint/manual types, scheduling.ts with constraint-aware forward/backward pass, test coverage for all constraint types and manual mode, database migration for new columns.
</objective>

<execution_context>
@C:/Users/User/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/User/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-constraints-manual-mode/05-CONTEXT.md
@.planning/phases/05-constraints-manual-mode/05-RESEARCH.md
@.planning/phases/04-scheduling-engine-foundation/04-01-SUMMARY.md
@flowplan/src/types/entities.ts
@flowplan/src/services/scheduling.ts
@flowplan/src/services/scheduling.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add constraint/manual types and write failing tests (RED)</name>
  <files>
    flowplan/src/types/entities.ts
    flowplan/src/services/scheduling.test.ts
    flowplan/supabase/migrations/007_add_constraints_manual_mode.sql
  </files>
  <action>
**1. Update entities.ts** -- Add type definitions after the existing enums section:

```typescript
export type ConstraintType = 'ASAP' | 'MSO' | 'SNET' | 'FNLT'
export type SchedulingMode = 'auto' | 'manual'
```

Add fields to the `Task` interface (after `is_critical`):

```typescript
// Constraint fields (Phase 5)
constraint_type: ConstraintType | null  // null = no constraint (default)
constraint_date: Date | string | null   // Required for MSO, SNET, FNLT
scheduling_mode: SchedulingMode         // 'auto' (default) or 'manual'
```

Add fields to `CreateTaskInput` (in entities.ts):

```typescript
constraint_type?: ConstraintType | null
constraint_date?: Date | string | null
scheduling_mode?: SchedulingMode
```

**IMPORTANT:** Default for new tasks is `constraint_type: null` (NO constraint), NOT 'ASAP'. This is a locked user decision.

**2. Create database migration** `007_add_constraints_manual_mode.sql`:

```sql
ALTER TABLE tasks
  ADD COLUMN constraint_type TEXT DEFAULT NULL
    CHECK (constraint_type IN ('ASAP', 'MSO', 'SNET', 'FNLT')),
  ADD COLUMN constraint_date DATE DEFAULT NULL,
  ADD COLUMN scheduling_mode TEXT DEFAULT 'auto' NOT NULL
    CHECK (scheduling_mode IN ('auto', 'manual'));
```

No index needed -- these columns are only read during CPM computation which loads all tasks anyway.

**3. Write failing test cases** in scheduling.test.ts. Add a new describe block `'Constraint types and manual mode'` with these test cases:

- **MSO constraint -- no dependency conflict**: Task with MSO date and no predecessors. ES should equal MSO date (snapped to next working day if needed).
- **MSO constraint -- dependency wins**: Task with MSO date but predecessor FS dependency finishes AFTER MSO date. ES should equal dependency-driven date (later), NOT the MSO date. This tests the locked decision "dependencies win over constraints."
- **MSO constraint -- constraint wins**: Task with MSO date and predecessor that finishes BEFORE MSO date. ES should equal MSO date.
- **SNET constraint -- standard behavior**: Task with SNET date. ES = max(dependency_ES, SNET_date). Test with SNET later than dependency.
- **SNET constraint -- dependency later**: Task with SNET date but dependency pushes later. ES = dependency date.
- **FNLT constraint -- no violation**: Task with FNLT date that finishes before the deadline. No violation flag.
- **FNLT constraint -- violation detected**: Task with FNLT date that finishes AFTER the deadline. Violation flag set.
- **ASAP constraint -- identical to no constraint**: Task with constraint_type='ASAP'. Behaves identically to constraint_type=null.
- **Manual task -- preserves user dates**: Task with scheduling_mode='manual' and user-set start_date/end_date. Forward pass uses those dates as ES/EF without modification.
- **Manual task -- drives successor dates**: Manual task is predecessor (FS) to an auto task. Successor's ES is computed from manual task's end_date.
- **Manual task -- not modified by backward pass**: Manual task's LS/LF come from its user dates, not backward pass computation.

For each test: create mock tasks with appropriate `constraint_type`, `constraint_date`, `scheduling_mode` fields. The existing `createMockTask` helper needs updating to include the new fields (default: `constraint_type: null`, `constraint_date: null`, `scheduling_mode: 'auto'`).

All tests should FAIL because the engine doesn't handle these fields yet.
  </action>
  <verify>
Run `cd flowplan && npx vitest run src/services/scheduling.test.ts` -- new tests should FAIL (RED phase). Existing tests should still PASS (no regression). TypeScript should compile without errors (`npx tsc --noEmit`).
  </verify>
  <done>
11 new test cases written and failing. Type definitions exist for ConstraintType, SchedulingMode. Task interface includes constraint_type, constraint_date, scheduling_mode. Database migration exists. createMockTask helper includes new fields with correct defaults.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement constraint and manual mode logic in scheduling engine (GREEN)</name>
  <files>
    flowplan/src/services/scheduling.ts
  </files>
  <action>
**Modify `forwardPass()` in scheduling.ts** to handle constraints and manual tasks:

**Step A: Manual task skip.** At the top of the task loop in forwardPass, BEFORE dependency resolution:

```typescript
if (task.scheduling_mode === 'manual') {
  // Manual task: preserve user dates, copy to ES/EF for dependency calculations
  task.es = this.toDate(task.start_date) || task.es
  task.ef = this.toDate(task.end_date) || task.ef
  continue // Skip dependency-driven computation
}
```

**Step B: Constraint application.** AFTER the existing dependency-driven ES computation (after `task.es` is set from predecessors), BEFORE computing EF:

```typescript
// Apply constraint logic (dependencies already resolved, dependency ES is computed)
const constraintDate = this.toDate(task.constraint_date)

if (constraintDate && (task.constraint_type === 'MSO' || task.constraint_type === 'SNET')) {
  const depES = task.es as Date
  const constraintWorking = this.findNextWorkingDay(constraintDate, workDays, holidays)
  // Dependencies win: take the later date (locked decision)
  if (constraintWorking > depES) {
    task.es = constraintWorking
  }
  // Track whether constraint was overridden for notification (transient, not persisted)
  ;(task as Record<string, unknown>)._constraintOverridden = depES > constraintWorking
}

// Compute EF after any constraint adjustment
task.ef = this.addWorkingDays(task.es!, task.duration, workDays, holidays)

// FNLT check (after EF is known)
if (task.constraint_type === 'FNLT' && constraintDate) {
  ;(task as Record<string, unknown>)._fnltViolation = (task.ef as Date) > constraintDate
}
```

**NOTE on ASAP:** ASAP and null constraint_type are handled identically -- no special code path. The absence of MSO/SNET/FNLT logic means the task is scheduled purely by dependencies, which IS the ASAP behavior.

**Step C: Modify `backwardPass()`** to handle manual tasks:

In the backward pass task loop, add at the top:

```typescript
if (task.scheduling_mode === 'manual') {
  // Manual task: use user dates as LS/LF for backward pass purposes
  task.ls = this.toDate(task.start_date) || task.ls
  task.lf = this.toDate(task.end_date) || task.lf
  continue
}
```

This ensures manual tasks contribute their dates to predecessor LF calculations but are not modified by the backward pass.

**Step D: Ensure `calculateCriticalPath()`** still works. Manual tasks participate in slack calculation naturally: if their user dates create zero slack relative to successors, they ARE on the critical path. No changes needed to calculateCriticalPath itself -- it delegates to forwardPass + backwardPass + calculateSlack.

**CRITICAL PITFALL AVOIDANCE:**
- Do NOT apply constraints in the backward pass (constraints are forward-pass only)
- Do NOT treat ASAP differently from null constraint_type in the engine
- Do NOT store _constraintOverridden or _fnltViolation in persistent state -- they are transient computation results
- Manual task skip MUST come before dependency resolution to avoid computing then discarding
  </action>
  <verify>
Run `cd flowplan && npx vitest run src/services/scheduling.test.ts` -- ALL tests (new + existing) should PASS (GREEN phase). Run `cd flowplan && npx tsc --noEmit` -- TypeScript compiles.
  </verify>
  <done>
All 11 new constraint/manual tests pass. All pre-existing CPM tests pass (zero regressions). Forward pass applies MSO/SNET as floor, detects FNLT violations, skips manual tasks. Backward pass skips manual tasks. ASAP behaves identically to null constraint.
  </done>
</task>

</tasks>

<verification>
1. `cd flowplan && npx vitest run src/services/scheduling.test.ts` -- All tests pass (existing + 11 new)
2. `cd flowplan && npx tsc --noEmit` -- TypeScript compiles
3. entities.ts contains `ConstraintType` and `SchedulingMode` types
4. scheduling.ts contains `constraint_type` handling in forwardPass
5. scheduling.ts contains `scheduling_mode === 'manual'` skip logic
6. Migration file 007_add_constraints_manual_mode.sql exists with ALTER TABLE
</verification>

<success_criteria>
- All scheduling tests pass (existing + new constraint/manual tests)
- TypeScript compiles without errors
- ConstraintType and SchedulingMode types exist in entities.ts
- Forward pass: MSO/SNET apply as floor (max of dependency ES and constraint date)
- Forward pass: FNLT detects violations but does not modify scheduling
- Forward pass: ASAP and null constraint behave identically
- Manual tasks skip forward/backward pass but contribute dates for successors
- Database migration adds constraint_type, constraint_date, scheduling_mode columns
</success_criteria>

<output>
After completion, create `.planning/phases/05-constraints-manual-mode/05-01-SUMMARY.md`
</output>
