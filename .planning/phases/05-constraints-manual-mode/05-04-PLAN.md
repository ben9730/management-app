---
phase: 05-constraints-manual-mode
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - flowplan/src/types/database.ts
  - flowplan/src/services/tasks.ts
  - flowplan/src/components/ui/Modal.tsx
  - flowplan/src/components/dependencies/DependencyManager.tsx
autonomous: false
gap_closure: true

must_haves:
  truths:
    - "Constraint type and date persist after saving and are loaded back when editing the task"
    - "Edit task modal is scrollable, closeable, and does not overflow the viewport"
    - "DependencyManager add form is collapsed by default, not expanded"
  artifacts:
    - path: "flowplan/src/types/database.ts"
      provides: "tasks Row/Insert/Update types include constraint_type, constraint_date, scheduling_mode"
      contains: "constraint_type"
    - path: "flowplan/src/services/tasks.ts"
      provides: "Task CRUD without 'as never' type casts"
    - path: "flowplan/src/components/ui/Modal.tsx"
      provides: "Scrollable modal with sticky header and max-height"
      contains: "max-h"
    - path: "flowplan/src/components/dependencies/DependencyManager.tsx"
      provides: "DependencyManager with isAdding default false"
  key_links:
    - from: "flowplan/src/services/tasks.ts"
      to: "flowplan/src/types/database.ts"
      via: "Supabase client uses Database type for insert/update"
      pattern: "from\\('tasks'\\)"
    - from: "flowplan/src/components/ui/Modal.tsx"
      to: "TaskForm rendered inside modal"
      via: "overflow-y-auto on content div"
      pattern: "overflow-y-auto"
---

<objective>
Close two UAT gaps from Phase 05 user testing:
1. Constraint fields (constraint_type, constraint_date, scheduling_mode) do not persist because database.ts types are missing these columns, causing PostgREST to silently drop them. The 'as never' casts in tasks.ts mask the type errors.
2. Task edit modal is too dense and cannot be closed because the modal has no max-height/scroll containment and the DependencyManager auto-expands its add form.

Purpose: Unblock all 6 skipped UAT tests (tests 5-10) that depend on constraint persistence, and fix the modal UX issue (test 11).
Output: Working constraint save/load, scrollable/closeable edit modal.
</objective>

<execution_context>
@.planning/phases/05-constraints-manual-mode/05-UAT.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/05-constraints-manual-mode/05-01-SUMMARY.md
@.planning/phases/05-constraints-manual-mode/05-02-SUMMARY.md
@flowplan/src/types/database.ts
@flowplan/src/services/tasks.ts
@flowplan/src/components/ui/Modal.tsx
@flowplan/src/components/dependencies/DependencyManager.tsx
@flowplan/supabase/migrations/007_add_constraints_manual_mode.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix constraint field persistence (database types + service casts)</name>
  <files>flowplan/src/types/database.ts, flowplan/src/services/tasks.ts</files>
  <action>
**Step 1 — Update database.ts tasks types**

Add three columns to the tasks table type in `flowplan/src/types/database.ts`. These must match migration 007 exactly:

In `tasks.Row`, add after `is_critical: boolean`:
```typescript
constraint_type: string | null    // 'ASAP' | 'MSO' | 'SNET' | 'FNLT' | null
constraint_date: string | null    // ISO date string
scheduling_mode: string           // 'auto' | 'manual'
```

In `tasks.Insert`, add after `is_critical?: boolean`:
```typescript
constraint_type?: string | null
constraint_date?: string | null
scheduling_mode?: string
```

In `tasks.Update`, add after `is_critical?: boolean`:
```typescript
constraint_type?: string | null
constraint_date?: string | null
scheduling_mode?: string
```

**Step 2 — Remove 'as never' casts from tasks.ts**

In `flowplan/src/services/tasks.ts`:

1. Line 111: Change `.insert(taskData as never)` to `.insert(taskData)`. The taskData object now matches the Insert type since database.ts has the constraint columns.

2. Line 190: Change `.update(updateData as never)` to `.update(updateData)`. Same reason -- UpdateTaskInput fields now align with the Update type.

3. Lines 252 and 267 in `batchUpdateTaskCPMFields`: Remove `as never` from both `.update(...)` calls. The update objects only contain fields that exist in the Update type.

**Why this fixes the bug:** PostgREST (Supabase) uses the TypeScript types to validate which columns are sent. When the types don't include constraint_type/constraint_date/scheduling_mode, the Supabase client silently strips them from the request payload. The 'as never' casts suppress the TypeScript errors that would have flagged this mismatch.

**Important:** If TypeScript errors appear after removing 'as never' (e.g., the updateData spread includes fields not in the Update type), fix by explicitly constructing the update object to only include known fields, rather than re-adding 'as never'. The batchUpdateTaskCPMFields manual-task branch may need explicit field listing rather than spreading, since it intentionally omits start_date/end_date.

**Step 3 — Verify migration 007 is applied to remote Supabase**

Run this check to confirm the columns exist in the remote database:
```bash
cd flowplan && npx supabase db diff --linked 2>&1 | head -50
```

If the migration is NOT applied (columns missing from remote), run:
```bash
cd flowplan && npx supabase db push
```

If supabase CLI is not linked or auth fails, create a `checkpoint:human-action` note in the SUMMARY explaining the user must apply migration 007 manually via the Supabase Dashboard SQL editor by running the contents of `flowplan/supabase/migrations/007_add_constraints_manual_mode.sql`.
  </action>
  <verify>
1. `cd flowplan && npx tsc --noEmit` — no type errors (confirms database.ts aligns with service usage)
2. `cd flowplan && npm run build` — builds successfully
3. Grep for 'as never' in tasks.ts: `grep -n "as never" flowplan/src/services/tasks.ts` — should return 0 results
4. Grep for constraint_type in database.ts: `grep -n "constraint_type" flowplan/src/types/database.ts` — should show 3 occurrences (Row, Insert, Update)
  </verify>
  <done>
database.ts tasks types include constraint_type, constraint_date, scheduling_mode in Row/Insert/Update. tasks.ts has zero 'as never' casts. TypeScript compiles cleanly. Constraint fields will now be sent to and received from Supabase.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix modal scroll/close UX and DependencyManager default state</name>
  <files>flowplan/src/components/ui/Modal.tsx, flowplan/src/components/dependencies/DependencyManager.tsx</files>
  <action>
**Step 1 — Fix Modal.tsx overflow and scroll containment**

In `flowplan/src/components/ui/Modal.tsx`:

1. On the dialog div (line ~138-142), change `overflow-visible` to add max-height and scroll:
   ```
   Before: 'relative w-full bg-white dark:bg-slate-800 shadow-2xl rounded-2xl overflow-visible fp-animate-slide-up'
   After:  'relative w-full max-h-[90vh] bg-white dark:bg-slate-800 shadow-2xl rounded-2xl overflow-hidden flex flex-col fp-animate-slide-up'
   ```
   Key changes: `overflow-visible` becomes `overflow-hidden`, add `max-h-[90vh]`, add `flex flex-col` for sticky header layout.

2. Make the header sticky. On the header div (line ~146), add sticky positioning:
   ```
   Before: 'flex items-center justify-between p-6 pb-2'
   After:  'flex items-center justify-between p-6 pb-2 sticky top-0 bg-white dark:bg-slate-800 z-10 border-b border-slate-200/10'
   ```
   This ensures the close button (X) is always visible and accessible regardless of scroll position.

3. Make the content div scrollable. On the content div (line ~176), add overflow scroll:
   ```
   Before: <div className="p-6">{children}</div>
   After:  <div className="p-6 overflow-y-auto flex-1 min-h-0">{children}</div>
   ```
   `flex-1 min-h-0` is needed inside a flex column to allow the content to shrink and scroll when it exceeds the available height after the sticky header.

4. If a footer div exists (line ~179-185), add `shrink-0` to prevent the footer from being pushed off-screen:
   ```
   Add 'shrink-0' to the footer div's className
   ```

**Step 2 — Fix DependencyManager default state**

In `flowplan/src/components/dependencies/DependencyManager.tsx`, line 48:
```
Before: const [isAdding, setIsAdding] = React.useState(true)
After:  const [isAdding, setIsAdding] = React.useState(false)
```

This collapses the add-dependency form by default, saving ~200px of vertical space in the task edit modal. Users click "Add dependency" button to expand it when needed.

Note: The comment on line 47 says "Auto-open the add form when there are no dependencies yet" — update or remove this comment since the behavior is changing. The button "Add dependency" is always visible when isAdding is false, so discoverability is maintained.
  </action>
  <verify>
1. `cd flowplan && npm run build` — builds successfully
2. Grep for overflow-visible in Modal.tsx: `grep -n "overflow-visible" flowplan/src/components/ui/Modal.tsx` — should return 0 results
3. Grep for max-h in Modal.tsx: `grep -n "max-h" flowplan/src/components/ui/Modal.tsx` — should show max-h-[90vh]
4. Grep for useState(true) in DependencyManager.tsx: `grep -n "useState(true)" flowplan/src/components/dependencies/DependencyManager.tsx` — should return 0 results
5. Grep for overflow-y-auto in Modal.tsx: `grep -n "overflow-y-auto" flowplan/src/components/ui/Modal.tsx` — should show content div
  </verify>
  <done>
Modal dialog has max-h-[90vh] with scrollable content area. Header with close button is sticky (always visible). DependencyManager add form starts collapsed. Edit modal is usable on all viewport sizes without overflow.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify constraint persistence and modal UX</name>
  <what-built>
Fixed constraint field persistence (database types aligned with migration 007, removed type casts masking errors) and fixed edit modal UX (scrollable, closeable, not overflowing).
  </what-built>
  <how-to-verify>
**Test A — Constraint saves and loads (UAT tests 3-4):**
1. Start dev server: `cd flowplan && npm run dev`
2. Open http://localhost:3000
3. Edit any existing task
4. In the "Advanced Scheduling" section, set constraint type to "Must Start On (MSO)" and pick a future date
5. Save the task
6. Re-open the same task for editing
7. EXPECTED: The constraint type dropdown shows "MSO" and the date picker shows the date you set

**Test B — SNET constraint (UAT test 4):**
1. Edit a different task, set constraint to "Start No Earlier Than (SNET)" with a future date
2. Save and re-open
3. EXPECTED: SNET and date are still there

**Test C — Modal scroll and close (UAT test 11):**
1. Edit a task that has dependencies (or any task with many fields)
2. EXPECTED: The modal has a scrollbar if content exceeds viewport height
3. EXPECTED: The close button (X) in the header is always visible at the top, even when scrolled down
4. EXPECTED: The dependency section starts collapsed (just shows count + "Add dependency" button, not the full add form)
5. Click the X button — modal should close normally

**If constraint save still fails:** The migration 007 may not be applied to your remote Supabase. Run this SQL in Supabase Dashboard > SQL Editor:
```sql
ALTER TABLE tasks
  ADD COLUMN IF NOT EXISTS constraint_type TEXT DEFAULT NULL
    CHECK (constraint_type IN ('ASAP', 'MSO', 'SNET', 'FNLT')),
  ADD COLUMN IF NOT EXISTS constraint_date DATE DEFAULT NULL,
  ADD COLUMN IF NOT EXISTS scheduling_mode TEXT DEFAULT 'auto' NOT NULL
    CHECK (scheduling_mode IN ('auto', 'manual'));
```
  </how-to-verify>
  <resume-signal>Type "approved" if both constraint persistence and modal UX work, or describe remaining issues</resume-signal>
</task>

</tasks>

<verification>
- `cd flowplan && npx tsc --noEmit` passes with zero errors
- `cd flowplan && npm run build` succeeds
- No 'as never' casts remain in tasks.ts
- database.ts tasks types include constraint_type, constraint_date, scheduling_mode
- Modal has max-h-[90vh], overflow-y-auto on content, sticky header
- DependencyManager isAdding defaults to false
</verification>

<success_criteria>
1. Constraint type and date persist when saving a task and are loaded back correctly when editing (unblocks UAT tests 3-10)
2. Edit task modal is scrollable with a sticky close button and does not overflow the viewport (fixes UAT test 11)
3. DependencyManager starts collapsed, reducing modal density
4. Zero TypeScript errors, build passes
</success_criteria>

<output>
After completion, create `.planning/phases/05-constraints-manual-mode/05-04-SUMMARY.md`
</output>
