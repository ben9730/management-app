---
phase: 05-constraints-manual-mode
plan: 03
type: execute
wave: 3
depends_on: ["05-01", "05-02"]
files_modified:
  - flowplan/src/components/gantt/GanttChart.tsx
autonomous: false

must_haves:
  truths:
    - "Constrained tasks (MSO/SNET) show a blue indicator dot on their Gantt bar"
    - "FNLT constrained tasks show a red indicator on their Gantt bar"
    - "FNLT violations show a red tint overlay on the task bar"
    - "FNLT deadline displays a diamond marker on the timeline at the deadline date position"
    - "Manual tasks show a dashed border on their Gantt bar distinguishing them from auto tasks"
    - "Hovering a constrained task shows the constraint type and date in the tooltip"
    - "Hovering a manual task shows 'ידני' (manual) in the tooltip"
  artifacts:
    - path: "flowplan/src/components/gantt/GanttChart.tsx"
      provides: "Constraint indicators, manual task styling, FNLT violation visuals, deadline markers"
      contains: "constraint_type"
  key_links:
    - from: "flowplan/src/components/gantt/GanttChart.tsx"
      to: "flowplan/src/types/entities.ts"
      via: "Reads constraint_type, constraint_date, scheduling_mode from Task objects"
      pattern: "task\\.constraint_type"
---

<objective>
Add visual indicators to the Gantt chart for constraint types, FNLT violations, and manual scheduling mode.

Purpose: Users need to see at a glance which tasks have constraints, which deadlines are violated, and which tasks are manually scheduled. This is the visual layer that makes constraints and manual mode discoverable and informative in the Gantt chart.

Output: GanttChart.tsx with constraint indicator dots (blue for MSO/SNET, red for FNLT), FNLT violation red tint overlay, FNLT deadline diamond marker on timeline, manual task dashed border, and updated tooltips showing constraint/manual info.
</objective>

<execution_context>
@C:/Users/User/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/User/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-constraints-manual-mode/05-CONTEXT.md
@.planning/phases/05-constraints-manual-mode/05-RESEARCH.md
@.planning/phases/05-constraints-manual-mode/05-01-SUMMARY.md
@.planning/phases/05-constraints-manual-mode/05-02-SUMMARY.md
@flowplan/src/components/gantt/GanttChart.tsx
@flowplan/src/types/entities.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add constraint indicators, manual mode styling, and FNLT violation visuals to GanttChart</name>
  <files>
    flowplan/src/components/gantt/GanttChart.tsx
  </files>
  <action>
**1. Add constraint type label map** near the top of the file (after imports):

```typescript
const constraintTypeLabels: Record<string, string> = {
  ASAP: 'בהקדם האפשרי',
  MSO: 'חייב להתחיל ב-',
  SNET: 'לא לפני',
  FNLT: 'לסיים לא אחרי',
}
```

**2. Add constraint indicator dot** to each task bar. Inside the task bar rendering (the div that represents the colored bar), add after the existing content:

For MSO/SNET constraints (blue indicator):
```tsx
{task.constraint_type && (task.constraint_type === 'MSO' || task.constraint_type === 'SNET') && (
  <span
    className="absolute -top-1.5 -right-1.5 w-4 h-4 rounded-full bg-blue-500 flex items-center justify-center z-10 pointer-events-none"
    title={`${constraintTypeLabels[task.constraint_type]}: ${task.constraint_date ? formatDateDisplay(task.constraint_date) : ''}`}
  >
    <span className="text-[7px] text-white font-bold">C</span>
  </span>
)}
```

For FNLT constraint (red indicator with exclamation):
```tsx
{task.constraint_type === 'FNLT' && (
  <span
    className="absolute -top-1.5 -left-1.5 w-4 h-4 rounded-full bg-red-500 flex items-center justify-center z-10 pointer-events-none"
    title={`${constraintTypeLabels.FNLT}: ${task.constraint_date ? formatDateDisplay(task.constraint_date) : ''}`}
  >
    <span className="text-[8px] text-white font-bold">!</span>
  </span>
)}
```

**3. Add FNLT violation red tint overlay** on the task bar. Check the transient `_fnltViolation` flag:

```tsx
{(task as Record<string, unknown>)._fnltViolation && (
  <div className="absolute inset-0 bg-red-500/20 rounded pointer-events-none" />
)}
```

**4. Add manual mode dashed border** on the task bar:

```tsx
{task.scheduling_mode === 'manual' && (
  <div className="absolute inset-0 border-2 border-dashed border-white/40 rounded pointer-events-none" />
)}
```

**5. Add FNLT deadline diamond marker** on the timeline. For each task with FNLT constraint, render a small diamond at the deadline date position. This should be rendered as part of the task row, positioned at the constraint date:

```tsx
{task.constraint_type === 'FNLT' && task.constraint_date && (() => {
  const deadlineDate = task.constraint_date instanceof Date
    ? task.constraint_date
    : new Date(task.constraint_date as string)
  const deadlineLeft = getDayOffset(deadlineDate) * currentDayWidth
  return (
    <div
      className="absolute w-3 h-3 bg-red-500 rotate-45 z-10"
      style={{
        left: `${deadlineLeft}px`,
        top: `${ROW_HEIGHT / 2 - 6}px`,
      }}
      title={`דדליין: ${formatDateDisplay(task.constraint_date)}`}
    />
  )
})()}
```

The `getDayOffset` function calculates the pixel position of a date on the timeline -- use the existing date-to-pixel conversion logic already present in the GanttChart (the same approach used for task bar positioning).

**6. Update task tooltip** (the hover tooltip on task bars). The GanttChart already has a tooltip pattern (from Phase 4 dependency lines). Add constraint and manual mode info to the existing task bar tooltip:

In the existing hover tooltip content, add:

```tsx
{/* Constraint info */}
{task.constraint_type && task.constraint_type !== 'ASAP' && (
  <div className="text-xs text-slate-400">
    {constraintTypeLabels[task.constraint_type]}{task.constraint_date ? `: ${formatDateDisplay(task.constraint_date)}` : ''}
  </div>
)}

{/* FNLT violation warning */}
{(task as Record<string, unknown>)._fnltViolation && (
  <div className="text-xs text-red-400 font-medium">
    חריגה מהדדליין!
  </div>
)}

{/* Manual mode indicator */}
{task.scheduling_mode === 'manual' && (
  <div className="text-xs text-amber-400">
    תזמון ידני
  </div>
)}
```

**7. Ensure the task type assertions work.** Since `constraint_type`, `constraint_date`, and `scheduling_mode` are now on the Task interface (from Plan 01), direct property access works. For transient flags `_constraintOverridden` and `_fnltViolation`, use `(task as Record<string, unknown>)._fnltViolation` since these are not on the Task interface.

**DESIGN RATIONALE (Claude's Discretion):**
- Blue dot for MSO/SNET: informational, not alarming. Blue is neutral.
- Red dot with "!" for FNLT: deadline constraint, warrants attention.
- Red tint overlay for FNLT violations: immediately visible warning.
- Diamond marker on timeline: standard PM convention for deadline markers (MS Project uses this).
- Dashed border for manual: universally recognized "different from normal" idiom.
- "C" letter in blue dot: compact, doesn't require icon library overhead.
  </action>
  <verify>
Run `cd flowplan && npm run build` -- build succeeds. Verify GanttChart.tsx contains `constraint_type` rendering logic. Verify GanttChart.tsx contains `scheduling_mode === 'manual'` dashed border. Verify GanttChart.tsx contains `_fnltViolation` red tint overlay.
  </verify>
  <done>
GanttChart shows blue indicator dots for MSO/SNET constrained tasks, red indicator for FNLT, red tint overlay for FNLT violations, diamond marker at deadline date, dashed border for manual tasks. Tooltips show constraint info, violation warnings, and manual mode indicator.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify constraints and manual mode end-to-end in browser</name>
  <files>flowplan/src/components/gantt/GanttChart.tsx</files>
  <action>
Start the dev server and verify the complete Phase 5 implementation works end-to-end. This checkpoint confirms all 3 plans work together correctly.

What was built:
- Engine handles constraint types (ASAP/MSO/SNET/FNLT) in forward/backward pass
- Task form has constraint type dropdown, date picker, and manual mode toggle
- Gantt chart shows visual indicators (constraint dots, FNLT violations, manual dashed borders)
- Toast notifications for constraint conflicts and deadline violations
- Manual task dates preserved during recalculation

Start dev server: `cd flowplan && npm run dev`

**Test 1: MSO Constraint**
1. Create or use a project with tasks
2. Edit a task, scroll to "תזמון מתקדם" section
3. Set constraint type to "חייב להתחיל ב- (MSO)"
4. Set a constraint date in the future
5. Verify the task's start date moves to the MSO date
6. Verify a blue "C" dot appears on the task's Gantt bar
7. Now create a dependency where a predecessor finishes AFTER the MSO date
8. Verify the task moves to the dependency date (later) and a toast appears explaining the constraint was adjusted

**Test 2: SNET Constraint**
1. Set constraint type to "לא לפני (SNET)" with a future date
2. Verify the task doesn't start before the SNET date
3. If a dependency pushes later, verify the dependency wins

**Test 3: FNLT Constraint**
1. Set constraint type to "לסיים לא אחרי (FNLT)" with a date
2. If the task finishes after the FNLT date, verify:
   - Red "!" indicator on the Gantt bar
   - Red tint overlay on the bar
   - Diamond marker on the timeline at the deadline date
   - Toast notification about deadline violation
3. If the task finishes before the FNLT date, verify no violation indicators

**Test 4: Manual Mode**
1. Edit a task, toggle "תזמון ידני" checkbox ON
2. Verify constraint fields disappear
3. Set custom start_date and end_date
4. Save the task
5. Change a predecessor task's duration
6. Verify the manual task's dates DID NOT change
7. Verify the manual task's successors DID update based on the manual task's dates
8. Verify the manual task bar has a dashed border in the Gantt chart

**Test 5: No Constraint Default**
1. Create a new task
2. Verify the constraint type is empty (no constraint) by default
3. Verify no constraint indicators on the Gantt bar
  </action>
  <verify>All 5 test scenarios pass in browser. Type "approved" if all tests pass, or describe issues found.</verify>
  <done>Phase 5 end-to-end verified: constraints pin tasks to dates, FNLT violations show warnings, manual tasks stay fixed during recalculation, visual indicators render correctly in Gantt chart.</done>
</task>

</tasks>

<verification>
1. `cd flowplan && npm run build` -- build succeeds
2. All scheduling tests pass: `cd flowplan && npx vitest run src/services/scheduling.test.ts`
3. GanttChart shows constraint indicators (blue dot for MSO/SNET, red for FNLT)
4. GanttChart shows FNLT violation red tint overlay when deadline exceeded
5. GanttChart shows diamond marker at FNLT deadline date
6. GanttChart shows dashed border on manual task bars
7. Tooltip shows constraint info and manual mode indicator
8. Manual task dates survive predecessor recalculation
9. Constraint conflicts produce toast notifications
</verification>

<success_criteria>
- MSO constraint pins task to specific date (or later if dependency pushes)
- SNET constraint prevents task starting before given date
- FNLT violation produces visual warning (red tint, diamond, toast)
- Manual tasks have fixed dates that survive predecessor changes
- Manual task successors still cascade from manual dates
- Visual distinction: blue dots (MSO/SNET), red indicators (FNLT), dashed border (manual)
- All behaviors verified in browser by human
</success_criteria>

<output>
After completion, create `.planning/phases/05-constraints-manual-mode/05-03-SUMMARY.md`
</output>
