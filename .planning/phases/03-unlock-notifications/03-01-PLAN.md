---
phase: 03-unlock-notifications
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - flowplan/src/hooks/use-phase-unlock-notifier.ts
  - flowplan/src/hooks/use-phase-unlock-notifier.test.ts
  - flowplan/src/app/layout.tsx
  - flowplan/src/app/page.tsx
autonomous: true
must_haves:
  truths:
    - "When a phase completes and the next phase unlocks, a Toast notification appears on screen"
    - "The Toast message includes the name of the completed phase and the name of the newly unlocked phase"
    - "The Toast auto-dismisses after 5 seconds and can be manually closed before that"
    - "No spurious toasts fire on initial page load"
    - "No spurious toasts fire when switching projects"
  artifacts:
    - path: "flowplan/src/hooks/use-phase-unlock-notifier.ts"
      provides: "Hook that detects locked-to-unlocked transitions and fires toast"
      exports: ["usePhaseUnlockNotifier"]
    - path: "flowplan/src/hooks/use-phase-unlock-notifier.test.ts"
      provides: "Tests for transition detection, initial-load silence, project-switch reset"
      min_lines: 50
    - path: "flowplan/src/app/layout.tsx"
      provides: "Sonner Toaster component mounted globally"
      contains: "Toaster"
    - path: "flowplan/src/app/page.tsx"
      provides: "usePhaseUnlockNotifier hook call wired to existing data"
      contains: "usePhaseUnlockNotifier"
  key_links:
    - from: "flowplan/src/hooks/use-phase-unlock-notifier.ts"
      to: "sonner"
      via: "toast.success() call on lock-to-unlock transition"
      pattern: "toast\\.success"
    - from: "flowplan/src/hooks/use-phase-unlock-notifier.ts"
      to: "flowplan/src/types/entities.ts"
      via: "PhaseLockInfo and ProjectPhase type imports"
      pattern: "PhaseLockInfo|ProjectPhase"
    - from: "flowplan/src/app/page.tsx"
      to: "flowplan/src/hooks/use-phase-unlock-notifier.ts"
      via: "hook call passing lockStatus, phases, isLoading"
      pattern: "usePhaseUnlockNotifier"
    - from: "flowplan/src/app/layout.tsx"
      to: "sonner"
      via: "Toaster component import and render"
      pattern: "from 'sonner'"
---

<objective>
Install Sonner toast library, create a usePhaseUnlockNotifier hook that detects phase lock-to-unlock transitions and fires Hebrew toast notifications, mount the Toaster in layout.tsx, and wire the hook into page.tsx.

Purpose: Complete Phase 3 (final phase) — users see a toast notification the moment a phase completes and the next phase becomes available for work.
Output: Working toast notification system for phase unlock events with tests.
</objective>

<execution_context>
@C:/Users/User/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/User/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-unlock-notifications/03-RESEARCH.md
@.planning/phases/02-lock-enforcement-ui/02-01-SUMMARY.md
@flowplan/src/hooks/use-phase-lock-status.ts
@flowplan/src/types/entities.ts
@flowplan/src/app/layout.tsx
@flowplan/src/app/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Sonner, create usePhaseUnlockNotifier hook with tests, mount Toaster in layout</name>
  <files>
    flowplan/src/hooks/use-phase-unlock-notifier.ts
    flowplan/src/hooks/use-phase-unlock-notifier.test.ts
    flowplan/src/app/layout.tsx
  </files>
  <action>
1. Install sonner: `cd flowplan && npm install sonner`

2. Create `flowplan/src/hooks/use-phase-unlock-notifier.ts`:
   - Import `useRef`, `useEffect` from react, `toast` from sonner, types `PhaseLockInfo` and `ProjectPhase` from `@/types/entities`
   - Export function `usePhaseUnlockNotifier(lockStatus: Map<string, PhaseLockInfo>, phases: ProjectPhase[], isLoading: boolean, projectId: string)`
   - Use `useRef<Map<string, PhaseLockInfo> | null>(null)` to store previous lock status
   - Use a second `useRef<string | null>(null)` to track the current projectId — when projectId changes, reset prevLockStatusRef to null (prevents spurious toasts on project switch)
   - In the useEffect:
     a. If `isLoading` or `lockStatus.size === 0`, return early (data not ready)
     b. If projectId changed since last render (compare with projectId ref), reset prevLockStatusRef to null and update projectId ref, then store current lockStatus and return (baseline for new project)
     c. If `prevLockStatusRef.current === null`, store current lockStatus as baseline and return (first render — no toasts)
     d. Iterate over lockStatus entries. For each entry where `prevInfo.isLocked === true && currentInfo.isLocked === false`:
        - Find the unlocked phase name from `phases` array by matching `phaseId`
        - Find the completed phase: use `currentInfo.blockedByPhaseId` from the PREVIOUS lock info (prevInfo) to identify which phase was blocking. Look up that phase's name from the `phases` array.
        - Actually, simpler approach: the completed phase is the one that was blocking the now-unlocked phase. `prevInfo.blockedByPhaseId` gives us its ID, `prevInfo.blockedByPhaseName` gives us its name directly.
        - Call `toast.success()` with Hebrew messages:
          - Title: `השלב "${completedPhaseName}" הושלם!` (Phase "X" completed!)
          - Description: `השלב "${unlockedPhaseName}" נפתח לעבודה` (Phase "Y" is now open for work)
          - Options: `{ duration: 5000, id: \`unlock-\${phaseId}\` }` (id prevents StrictMode duplicates)
     e. Update prevLockStatusRef.current with a new Map copy of current lockStatus
   - Dependencies array: `[lockStatus, phases, isLoading, projectId]`

3. Create `flowplan/src/hooks/use-phase-unlock-notifier.test.ts`:
   - Mock sonner: `vi.mock('sonner', () => ({ toast: { success: vi.fn() } }))`
   - Import `renderHook` from `@testing-library/react`, `vi` from vitest
   - Helper: `makePhase(overrides)` returns a minimal ProjectPhase object
   - Helper: `makeLockInfo(overrides)` returns a PhaseLockInfo object
   - Test cases (at minimum):
     a. "does not fire toast on initial render (baseline capture)" — render with some locked phases, verify toast.success not called
     b. "fires toast when phase transitions from locked to unlocked" — first render with phase 2 locked, rerender with phase 2 unlocked, verify toast.success called once with correct Hebrew strings containing both phase names
     c. "does not fire toast when phase stays unlocked across rerenders" — both renders have phase unlocked, no toast
     d. "does not fire toast when isLoading is true" — render with isLoading=true, no toast
     e. "resets baseline on project switch (no spurious toasts)" — render with projectId='A' and phase locked, rerender with projectId='B' and different lock status, verify no toast fires (baseline reset)
     f. "uses stable toast id to prevent duplicates" — verify the `id` option is passed as `unlock-{phaseId}`
   - Use `afterEach(() => vi.clearAllMocks())` to reset between tests

4. Modify `flowplan/src/app/layout.tsx`:
   - layout.tsx is a Server Component. Sonner's `<Toaster>` is a client component. Next.js supports importing client components into server components, so import directly: `import { Toaster } from 'sonner'`
   - Add `<Toaster dir="rtl" theme="dark" position="top-center" closeButton duration={5000} richColors />` inside the `<body>` element, AFTER the closing `</QueryProvider>` tag (sibling, not child — Toaster doesn't need React Query context). Place it just before `</body>`.
   - If a hydration error occurs during testing, wrap in a client component. But try direct import first since Sonner is designed for this.
  </action>
  <verify>
    - `cd flowplan && npx vitest run src/hooks/use-phase-unlock-notifier.test.ts` — all tests pass
    - `cd flowplan && npm run build` — no build/type errors
    - Verify sonner is in package.json dependencies
  </verify>
  <done>
    - usePhaseUnlockNotifier hook exists with transition detection, initial-load silence, and project-switch reset
    - Test file has 5+ passing tests covering all critical scenarios
    - Toaster component is mounted in layout.tsx with dir="rtl", theme="dark", closeButton, duration=5000
    - Build succeeds with no errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire usePhaseUnlockNotifier into page.tsx DashboardContent</name>
  <files>
    flowplan/src/app/page.tsx
  </files>
  <action>
1. In `flowplan/src/app/page.tsx`:
   - Add import: `import { usePhaseUnlockNotifier } from '@/hooks/use-phase-unlock-notifier'`
   - Find the existing line (around line 233): `const { isLocked, getLockInfo } = usePhaseLockStatus(projectId)`
   - Change destructuring to also extract `lockStatus` and `isLoading` (alias to avoid conflict with existing isLoading): `const { lockStatus, isLocked, getLockInfo, isLoading: isLoadingLock } = usePhaseLockStatus(projectId)`
   - Add one line immediately after: `usePhaseUnlockNotifier(lockStatus, phases, isLoadingLock || isLoadingPhases, projectId)`
   - This passes:
     - `lockStatus` — the Map<string, PhaseLockInfo> from usePhaseLockStatus
     - `phases` — already available from `usePhases(projectId)` on line 173
     - `isLoadingLock || isLoadingPhases` — combined loading state (both must be ready)
     - `projectId` — already available in DashboardContent scope

2. Verify the existing `isLoading` variable (line ~254) still works. It currently uses `isLoadingPhases` which is still available. The new `isLoadingLock` alias doesn't conflict.
  </action>
  <verify>
    - `cd flowplan && npm run build` — build succeeds
    - `cd flowplan && npx vitest run src/hooks/use-phase-unlock-notifier.test.ts` — tests still pass
    - Grep page.tsx for `usePhaseUnlockNotifier` — returns a match
  </verify>
  <done>
    - page.tsx imports and calls usePhaseUnlockNotifier with correct arguments
    - lockStatus and isLoading are properly destructured from usePhaseLockStatus
    - Build succeeds, no regressions
  </done>
</task>

</tasks>

<verification>
1. `cd flowplan && npm run build` — clean build, no type errors
2. `cd flowplan && npx vitest run src/hooks/use-phase-unlock-notifier.test.ts` — all hook tests pass
3. `cd flowplan && npm run test:run` — full test suite passes (no regressions)
4. Verify sonner in package.json: `grep sonner flowplan/package.json`
5. Verify Toaster in layout: `grep -n Toaster flowplan/src/app/layout.tsx`
6. Verify hook wired in page: `grep -n usePhaseUnlockNotifier flowplan/src/app/page.tsx`
</verification>

<success_criteria>
- Sonner installed and Toaster mounted globally with RTL + dark mode + closeButton + 5s duration
- usePhaseUnlockNotifier hook detects locked->unlocked transitions and fires Hebrew toast with both phase names
- No toasts on initial page load (baseline capture pattern)
- No spurious toasts on project switch (projectId reset pattern)
- StrictMode duplicate prevention via stable toast id
- Hook wired into page.tsx with 2 lines of change (destructuring update + hook call)
- All tests pass, build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/03-unlock-notifications/03-01-SUMMARY.md`
</output>
