---
phase: 06-progress-tracking
plan: 03
type: execute
wave: 3
depends_on: ["06-01", "06-02"]
files_modified:
  - flowplan/src/app/page.tsx
  - flowplan/src/components/forms/TaskForm.tsx
  - flowplan/src/components/gantt/GanttChart.tsx
autonomous: true
requirements:
  - PROG-01
  - PROG-07

must_haves:
  truths:
    - "User can set percent complete (0-100) on a task via a slider in the task form"
    - "Changing percent complete in the form triggers syncProgressAndStatus before saving"
    - "Task status checkbox on TaskCard goes through syncProgressAndStatus"
    - "Gantt bars show a darker progress fill covering the completed percentage"
    - "Task detail sidebar displays current percent complete"
  artifacts:
    - path: "flowplan/src/components/forms/TaskForm.tsx"
      provides: "Percent complete slider/input in task form"
      contains: "percent_complete"
    - path: "flowplan/src/components/gantt/GanttChart.tsx"
      provides: "Progress bar overlay on Gantt task bars"
      contains: "percent_complete"
    - path: "flowplan/src/app/page.tsx"
      provides: "Wired handlers using syncProgressAndStatus, sidebar percent display"
      contains: "syncProgressAndStatus"
  key_links:
    - from: "flowplan/src/app/page.tsx"
      to: "flowplan/src/services/progress-sync.ts"
      via: "import and call syncProgressAndStatus in handleTaskStatusChange and handleTaskFormSubmit"
      pattern: "syncProgressAndStatus"
    - from: "flowplan/src/components/forms/TaskForm.tsx"
      to: "flowplan/src/app/page.tsx"
      via: "onSubmit callback passes percent_complete to handleTaskFormSubmit"
      pattern: "percent_complete"
    - from: "flowplan/src/components/gantt/GanttChart.tsx"
      to: "flowplan/src/types/entities.ts"
      via: "Task.percent_complete used for progress bar width calculation"
      pattern: "percent_complete"
---

<objective>
Add UI controls for setting percent complete and wire all task update paths through syncProgressAndStatus. Add Gantt progress bar overlay.

Purpose: This is the user-facing layer -- users need to see and control progress on their tasks, and the Gantt chart needs to visualize completion state. All task mutations must go through the sync function to maintain percent/status consistency.

Output: TaskForm with percent_complete slider, wired handleTaskStatusChange/handleTaskFormSubmit using syncProgressAndStatus, Gantt progress bar overlay, sidebar percent display.
</objective>

<execution_context>
@C:/Users/User/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/User/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-progress-tracking/06-RESEARCH.md
@.planning/phases/06-progress-tracking/06-01-SUMMARY.md
@.planning/phases/06-progress-tracking/06-02-SUMMARY.md
@flowplan/src/app/page.tsx
@flowplan/src/components/forms/TaskForm.tsx
@flowplan/src/components/gantt/GanttChart.tsx
@flowplan/src/services/progress-sync.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire syncProgressAndStatus into task update paths and add sidebar percent display</name>
  <files>
    flowplan/src/app/page.tsx
    flowplan/src/components/forms/TaskForm.tsx
  </files>
  <action>
    **Part A: TaskForm percent_complete control**

    In `TaskForm.tsx`, add a percent_complete field to the form:

    1. Add `percent_complete` to the form's data type and initial state (default to editingTask's percent_complete or 0).

    2. Add a slider + number input below the existing form fields (above the constraint section). Hebrew label: "אחוז השלמה" (percent complete):
       ```tsx
       <div className="space-y-1">
         <label className="text-xs font-bold text-slate-500 uppercase tracking-wider">
           אחוז השלמה
         </label>
         <div className="flex items-center gap-3">
           <input
             type="range"
             min={0}
             max={100}
             step={5}
             value={percentComplete}
             onChange={(e) => setPercentComplete(Number(e.target.value))}
             className="flex-1 accent-[var(--fp-brand-primary)]"
             data-testid="percent-complete-slider"
           />
           <input
             type="number"
             min={0}
             max={100}
             value={percentComplete}
             onChange={(e) => setPercentComplete(Math.max(0, Math.min(100, Number(e.target.value))))}
             className="w-16 text-center bg-slate-700 border border-slate-600 rounded-lg px-2 py-1 text-sm"
             data-testid="percent-complete-input"
           />
           <span className="text-sm font-bold w-4">%</span>
         </div>
       </div>
       ```

    3. Include `percent_complete` in the onSubmit callback data. The form passes percent_complete to the parent; the parent (page.tsx) handles the sync logic.

    4. When `scheduling_mode === 'manual'`, still show the percent_complete control (progress tracking works for both auto and manual tasks).

    **Part B: Wire handleTaskFormSubmit with syncProgressAndStatus**

    In `page.tsx`, modify `handleTaskFormSubmit`:

    1. Import `syncProgressAndStatus` from `@/services/progress-sync`.

    2. In the submit handler, BEFORE calling `createTaskMutation` or `updateTaskMutation`, apply the sync function:
       ```typescript
       // Apply progress sync before saving
       const existingTask = editingTask  // may be null for new tasks
       if (existingTask && data.percent_complete !== undefined) {
         const syncResult = syncProgressAndStatus(
           {
             percent_complete: existingTask.percent_complete ?? 0,
             status: existingTask.status,
             actual_start_date: existingTask.actual_start_date as string | null,
           },
           { percent_complete: data.percent_complete }
         )
         // Merge sync results into the update
         updates.status = syncResult.status
         updates.percent_complete = syncResult.percent_complete
         if (syncResult.actual_start_date !== undefined) {
           updates.actual_start_date = syncResult.actual_start_date
         }
         if (syncResult.actual_finish_date !== undefined) {
           updates.actual_finish_date = syncResult.actual_finish_date
         }
       }
       ```

    3. For new tasks, if percent_complete is set to >0, also apply sync to get correct initial status and actual_start_date.

    **Part C: Wire handleTaskStatusChange with syncProgressAndStatus**

    In `page.tsx`, modify `handleTaskStatusChange` (line ~361):

    1. Instead of passing `{ status: newStatus }` directly, apply syncProgressAndStatus:
       ```typescript
       const task = tasks.find(t => t.id === taskId)
       if (!task) return

       const syncResult = syncProgressAndStatus(
         {
           percent_complete: task.percent_complete ?? 0,
           status: task.status,
           actual_start_date: task.actual_start_date as string | null,
         },
         { status: newStatus }
       )

       const updatedTask = await updateTaskMutation.mutateAsync({
         id: taskId,
         updates: {
           status: syncResult.status,
           percent_complete: syncResult.percent_complete,
           ...(syncResult.actual_start_date !== undefined && { actual_start_date: syncResult.actual_start_date }),
           ...(syncResult.actual_finish_date !== undefined && { actual_finish_date: syncResult.actual_finish_date }),
         }
       })
       ```

    **Part D: Sidebar percent display**

    In the task detail sidebar section of `page.tsx` (around line ~985), add a percent complete display after the "זמן מוערך" (estimated time) section:

    ```tsx
    <div className="flex items-center gap-4 text-slate-300">
      <div className="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center text-slate-400">
        <BarChart3 className="w-5 h-5" />
      </div>
      <div className="flex-1">
        <div className="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1">התקדמות</div>
        <div className="flex items-center gap-3">
          <div className="flex-1 h-2 bg-slate-700 rounded-full overflow-hidden">
            <div
              className="h-full bg-[var(--fp-brand-primary)] rounded-full transition-all"
              style={{ width: `${selectedTask.percent_complete ?? 0}%` }}
            />
          </div>
          <span className="text-sm font-bold w-10 text-left">{selectedTask.percent_complete ?? 0}%</span>
        </div>
      </div>
    </div>
    ```

    Import `BarChart3` from lucide-react (already available in the project).

    Also show actual_start_date and actual_finish_date in the sidebar if set:
    ```tsx
    {selectedTask.actual_start_date && (
      <div className="text-[10px] text-slate-500 mt-1">
        התחלה בפועל: {formatDate(selectedTask.actual_start_date)}
        {selectedTask.actual_finish_date && ` | סיום בפועל: ${formatDate(selectedTask.actual_finish_date)}`}
      </div>
    )}
    ```
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run build` passes
    - TaskForm has percent_complete slider with step=5 and number input
    - handleTaskStatusChange uses syncProgressAndStatus
    - handleTaskFormSubmit uses syncProgressAndStatus for percent changes
    - Sidebar shows progress bar and percent value
  </verify>
  <done>Users can set percent_complete in the task form, the status checkbox syncs through syncProgressAndStatus, and the sidebar shows a progress bar with actual dates when available.</done>
</task>

<task type="auto">
  <name>Task 2: Gantt chart progress bar overlay</name>
  <files>flowplan/src/components/gantt/GanttChart.tsx</files>
  <action>
    In `GanttChart.tsx`, add a progress fill overlay inside each task bar. The overlay goes INSIDE the inner bar div (the one with `className="w-full h-full rounded-lg relative overflow-hidden..."` at line ~541), AFTER the existing progress stripe pattern for in_progress and BEFORE the FNLT violation overlay.

    Add between the "Checkmark icon for done tasks" and "Task Title" sections (around line ~558):

    ```tsx
    {/* Progress fill overlay (Phase 6) */}
    {task.percent_complete > 0 && task.percent_complete < 100 && (
      <div
        className="absolute inset-y-0 left-0 bg-black/20 pointer-events-none"
        style={{
          width: `${task.percent_complete}%`,
          borderRadius: task.percent_complete < 95 ? '0.5rem 0 0 0.5rem' : '0.5rem',
        }}
        data-testid={`progress-fill-${task.id}`}
      />
    )}
    ```

    Note: Use `left-0` (not `right-0`) because Gantt bars fill from left to right regardless of RTL page direction. The `borderRadius` applies the left rounded corner to match the parent bar, but not the right corner (which is a sharp edge showing progress boundary) unless nearly complete.

    Also replace the existing "Progress stripe pattern for in_progress" animation (line ~553):
    ```tsx
    {/* Old: */}
    {task.status === 'in_progress' && (
      <div className="absolute inset-0 opacity-20 bg-gradient-to-r from-transparent via-white to-transparent animate-pulse" />
    )}
    ```

    Replace with a progress-aware version:
    ```tsx
    {/* Progress stripe for in_progress tasks without explicit percent */}
    {task.status === 'in_progress' && (task.percent_complete === 0 || task.percent_complete === undefined) && (
      <div className="absolute inset-0 opacity-20 bg-gradient-to-r from-transparent via-white to-transparent animate-pulse" />
    )}
    ```

    This way, the old pulse animation only shows for in_progress tasks that haven't set a percent_complete yet. Once percent_complete is set, the darker fill overlay shows the actual progress instead.

    For 100% complete tasks, the existing "done" status color + checkmark is sufficient visual feedback. No progress overlay needed at 100%.

    In the Gantt legend section (around line ~355), add a legend entry for progress fill:
    ```tsx
    <span className="flex items-center gap-1.5 text-xs text-slate-400">
      <span className="w-6 h-3 rounded bg-[var(--fp-status-warning)] relative overflow-hidden">
        <span className="absolute inset-y-0 left-0 w-1/2 bg-black/20" />
      </span>
      התקדמות
    </span>
    ```
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run build` passes
    - Task bars with percent_complete 1-99 show a darker left-side overlay proportional to percent
    - Task bars at 0% or 100% do NOT show the progress overlay
    - The old pulse animation only shows for in_progress tasks without explicit percent
    - Gantt legend includes progress indicator
  </verify>
  <done>Gantt chart task bars display a visual progress fill (darker overlay from left) proportional to task.percent_complete. Legend updated. Pulse animation coexists correctly with progress fill.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- `npm run build` passes
- `npm run dev` → navigate to a project → can set percent on a task via form → status syncs
- Gantt bars show progress fill for tasks with 1-99% complete
- Sidebar shows progress bar with percent value and actual dates
- Checking task done via TaskCard checkbox sets percent to 100 and records actual dates
</verification>

<success_criteria>
- User can set percent complete on any task via slider (step=5) or number input
- Changing percent syncs status bidirectionally via syncProgressAndStatus
- Changing status via TaskCard checkbox syncs percent via syncProgressAndStatus
- Gantt bars show darker progress fill proportional to percent_complete
- Sidebar displays progress bar, percent value, and actual dates when available
- No type errors, build passes
</success_criteria>

<output>
After completion, create `.planning/phases/06-progress-tracking/06-03-SUMMARY.md`
</output>
