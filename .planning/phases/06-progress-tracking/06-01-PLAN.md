---
phase: 06-progress-tracking
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - flowplan/supabase/migrations/008_add_progress_tracking.sql
  - flowplan/src/types/entities.ts
  - flowplan/src/types/database.ts
  - flowplan/src/services/tasks.ts
  - flowplan/src/services/progress-sync.ts
  - flowplan/src/services/progress-sync.test.ts
autonomous: true
requirements:
  - PROG-02
  - PROG-03
  - PROG-04

must_haves:
  truths:
    - "syncProgressAndStatus returns correct status for any percent_complete value (0=pending, 1-99=in_progress, 100=done)"
    - "syncProgressAndStatus returns correct percent for any status change (done=100, pending=0, in_progress=max(current,1))"
    - "actual_start_date is set on first transition from 0 to >0 percent and never overwritten"
    - "actual_finish_date is set when percent reaches 100 and cleared when percent drops below 100"
    - "Database migration adds percent_complete, actual_start_date, actual_finish_date columns with correct constraints"
  artifacts:
    - path: "flowplan/src/services/progress-sync.ts"
      provides: "Bidirectional percent/status sync function"
      exports: ["syncProgressAndStatus"]
    - path: "flowplan/src/services/progress-sync.test.ts"
      provides: "TDD tests for sync function"
      min_lines: 80
    - path: "flowplan/supabase/migrations/008_add_progress_tracking.sql"
      provides: "Database columns for progress tracking"
      contains: "percent_complete"
    - path: "flowplan/src/types/entities.ts"
      provides: "Task type with progress fields"
      contains: "percent_complete"
  key_links:
    - from: "flowplan/src/services/progress-sync.ts"
      to: "flowplan/src/types/entities.ts"
      via: "imports Task type for ProgressSyncResult typing"
      pattern: "import.*Task.*entities"
---

<objective>
Add the database schema, TypeScript types, and bidirectional percent/status sync logic for progress tracking.

Purpose: Establish the data foundation (DB columns, types) and the core business logic (syncProgressAndStatus) that all downstream plans depend on. The sync function ensures percent_complete and status are always consistent, and auto-records actual_start_date/actual_finish_date at the correct transitions.

Output: Database migration, updated Task type with progress fields, tested pure sync function ready for integration.
</objective>

<execution_context>
@C:/Users/User/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/User/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-progress-tracking/06-RESEARCH.md
@flowplan/src/types/entities.ts
@flowplan/src/services/tasks.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration and type extensions</name>
  <files>
    flowplan/supabase/migrations/008_add_progress_tracking.sql
    flowplan/src/types/entities.ts
    flowplan/src/types/database.ts
    flowplan/src/services/tasks.ts
  </files>
  <action>
    1. Create migration `flowplan/supabase/migrations/008_add_progress_tracking.sql`:
       ```sql
       ALTER TABLE tasks
         ADD COLUMN percent_complete INTEGER DEFAULT 0 NOT NULL
           CHECK (percent_complete >= 0 AND percent_complete <= 100),
         ADD COLUMN actual_start_date DATE DEFAULT NULL,
         ADD COLUMN actual_finish_date DATE DEFAULT NULL;

       ALTER TABLE tasks
         ADD CONSTRAINT valid_actual_dates
           CHECK (actual_finish_date IS NULL OR actual_start_date IS NULL
                  OR actual_finish_date >= actual_start_date);
       ```

    2. In `entities.ts`, add three fields to the `Task` interface after `scheduling_mode`:
       ```typescript
       // Progress tracking fields (Phase 6)
       percent_complete: number          // 0-100
       actual_start_date: Date | string | null  // Set when work begins
       actual_finish_date: Date | string | null  // Set when work completes
       ```
       Also add `percent_complete?: number`, `actual_start_date?: Date | string | null`, `actual_finish_date?: Date | string | null` to `CreateTaskInput` interface.

    3. In `database.ts`, add the three columns to the tasks Row, Insert, and Update types.

    4. In `tasks.ts`, add to `UpdateTaskInput`:
       ```typescript
       percent_complete?: number
       actual_start_date?: string | null
       actual_finish_date?: string | null
       ```
       Also add same fields to `CreateTaskInput` in tasks.ts.

    Apply the migration to the Supabase project database.
  </action>
  <verify>
    - Migration file exists at `flowplan/supabase/migrations/008_add_progress_tracking.sql`
    - `npx tsc --noEmit` passes (no type errors)
    - `Task` interface in entities.ts includes percent_complete, actual_start_date, actual_finish_date
    - `UpdateTaskInput` in tasks.ts includes the three new fields
  </verify>
  <done>Database has percent_complete (INTEGER 0-100 with CHECK), actual_start_date (DATE), actual_finish_date (DATE) columns. TypeScript types match across entities.ts, database.ts, and tasks.ts.</done>
</task>

<task type="auto">
  <name>Task 2: TDD — syncProgressAndStatus pure function</name>
  <files>
    flowplan/src/services/progress-sync.ts
    flowplan/src/services/progress-sync.test.ts
  </files>
  <action>
    **RED phase — Write tests first** in `progress-sync.test.ts`:

    Test the `syncProgressAndStatus(currentTask, change)` function with these cases:

    **Percent-driven sync:**
    - percent_complete=0 → status='pending', actual_finish_date=null
    - percent_complete=50 → status='in_progress', actual_start_date set (if not already set)
    - percent_complete=100 → status='done', actual_finish_date set, actual_start_date set if missing
    - percent_complete goes from 50 back to 0 → status='pending', actual_finish_date=null, actual_start_date PRESERVED (not cleared)
    - percent_complete=50 when actual_start_date already set → actual_start_date NOT overwritten

    **Status-driven sync:**
    - status='done' → percent_complete=100, actual_finish_date set, actual_start_date set if missing
    - status='pending' → percent_complete=0, actual_finish_date=null, actual_start_date preserved
    - status='in_progress' → percent_complete=max(current, 1), actual_start_date set if missing

    **Edge cases:**
    - No change object → returns current state unchanged
    - percent_complete out of range (negative, >100) → clamp to 0-100

    Run tests → they MUST fail (RED).

    **GREEN phase — Implement** `syncProgressAndStatus` in `progress-sync.ts`:

    ```typescript
    import type { TaskStatus } from '@/types/entities'

    export interface ProgressSyncInput {
      percent_complete: number
      status: TaskStatus
      actual_start_date: string | null
    }

    export interface ProgressSyncChange {
      percent_complete?: number
      status?: TaskStatus
    }

    export interface ProgressSyncResult {
      percent_complete: number
      status: TaskStatus
      actual_start_date?: string | null
      actual_finish_date?: string | null
    }

    export function syncProgressAndStatus(
      current: ProgressSyncInput,
      change: ProgressSyncChange,
      today?: string  // injectable for testing, defaults to new Date().toISOString().split('T')[0]
    ): ProgressSyncResult
    ```

    Key logic:
    - If `change.percent_complete` is defined: derive status from percent (0=pending, 100=done, else in_progress). Set actual_start_date on first >0 if not already set. Set actual_finish_date at 100, clear at <100.
    - If `change.status` is defined: derive percent from status (done=100, pending=0, in_progress=max(current,1)). Set actual dates accordingly.
    - Clamp percent_complete to 0-100 range.
    - The `today` parameter allows deterministic testing (defaults to current date).
    - CRITICAL: Never clear actual_start_date when reverting to 0/pending (MS Project behavior — actual dates are historical records).

    Run tests → they MUST pass (GREEN).

    **REFACTOR phase:** Clean up if needed, ensure exports are clean.
  </action>
  <verify>
    - `npx vitest run flowplan/src/services/progress-sync.test.ts` → all tests pass
    - At least 10 test cases covering percent-driven, status-driven, and edge cases
    - `syncProgressAndStatus` is exported from progress-sync.ts
  </verify>
  <done>Pure function `syncProgressAndStatus` handles bidirectional percent/status sync with actual date auto-recording. All test cases pass. Function is ready for integration into task update paths.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- `npx vitest run flowplan/src/services/progress-sync.test.ts` passes with 10+ test cases
- Migration file exists with correct SQL
- Task type includes all three progress fields
- UpdateTaskInput includes all three progress fields
</verification>

<success_criteria>
- Database schema extended with percent_complete, actual_start_date, actual_finish_date
- TypeScript types updated across entities.ts, database.ts, tasks.ts
- syncProgressAndStatus pure function fully tested and exported
- No type errors in the project
</success_criteria>

<output>
After completion, create `.planning/phases/06-progress-tracking/06-01-SUMMARY.md`
</output>
