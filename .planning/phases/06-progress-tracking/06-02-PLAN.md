---
phase: 06-progress-tracking
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - flowplan/src/services/scheduling.ts
  - flowplan/src/services/tasks.ts
autonomous: true
requirements:
  - PROG-05
  - PROG-06

must_haves:
  truths:
    - "A task with percent_complete=100 and actual dates does not change its ES/EF when predecessors are rescheduled"
    - "A task with percent_complete>0 and actual_start_date cannot have its ES move earlier than actual_start_date"
    - "Frozen tasks have LS=ES and LF=EF (zero slack) in the backward pass"
    - "batchUpdateTaskCPMFields does not overwrite start_date/end_date for completed tasks"
  artifacts:
    - path: "flowplan/src/services/scheduling.ts"
      provides: "Frozen/in-progress task handling in forward and backward pass"
      contains: "percent_complete"
    - path: "flowplan/src/services/tasks.ts"
      provides: "Completed task branch in batchUpdateTaskCPMFields"
      contains: "percent_complete"
  key_links:
    - from: "flowplan/src/services/scheduling.ts"
      to: "flowplan/src/types/entities.ts"
      via: "Task.percent_complete field used in forward/backward pass skip logic"
      pattern: "percent_complete.*100"
    - from: "flowplan/src/services/tasks.ts"
      to: "flowplan/src/services/scheduling.ts"
      via: "batchUpdateTaskCPMFields persists scheduling results respecting frozen state"
      pattern: "percent_complete.*100"
---

<objective>
Extend the CPM scheduling engine to handle frozen (completed) and in-progress tasks, and update the batch persist function to respect their dates.

Purpose: Completed tasks (100%) must be immovable in the schedule -- their actual dates are preserved regardless of predecessor changes. In-progress tasks cannot move backward past their actual start date. This is the core scheduling behavior that makes progress tracking meaningful.

Output: Modified scheduling engine (forwardPass + backwardPass) with frozen/in-progress handling, updated batchUpdateTaskCPMFields with completed task branch.
</objective>

<execution_context>
@C:/Users/User/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/User/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-progress-tracking/06-RESEARCH.md
@.planning/phases/06-progress-tracking/06-01-SUMMARY.md
@flowplan/src/services/scheduling.ts
@flowplan/src/services/tasks.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Forward and backward pass frozen/in-progress task handling</name>
  <files>flowplan/src/services/scheduling.ts</files>
  <action>
    Modify `forwardPass()` in scheduling.ts. After the existing manual task skip (line ~327, `if (task.scheduling_mode === 'manual')`), add a frozen task skip block BEFORE dependency resolution:

    ```typescript
    // Step B: Completed task freeze (Phase 6) -- frozen tasks use actual dates, never recompute
    if (task.percent_complete === 100 && task.actual_start_date && task.actual_finish_date) {
      task.es = this.toDate(task.actual_start_date)
      task.ef = this.toDate(task.actual_finish_date)
      continue  // frozen, skip dependency resolution entirely
    }
    ```

    Then, AFTER dependency resolution but BEFORE constraint logic (existing Step B which becomes Step C), add an in-progress floor clamp:

    ```typescript
    // Step D: In-progress floor clamp (Phase 6) -- cannot move backward past actual start
    if (task.percent_complete > 0 && task.actual_start_date) {
      const actualStart = this.toDate(task.actual_start_date)
      if (actualStart && task.es instanceof Date && task.es < actualStart) {
        task.es = actualStart
      }
    }
    ```

    The ordering in the forward pass loop should be:
    1. Manual task skip (existing) → continue
    2. Frozen task skip (NEW) → continue
    3. Dependency resolution (existing)
    4. In-progress floor clamp (NEW)
    5. Constraint logic (existing)
    6. EF calculation (existing)

    Modify `backwardPass()` in scheduling.ts. After the existing manual task skip (line ~495, `if (task.scheduling_mode === 'manual')`), add a frozen task skip:

    ```typescript
    // Completed task freeze: LS=ES, LF=EF (Phase 6)
    if (task.percent_complete === 100) {
      task.ls = task.es
      task.lf = task.ef
      continue
    }
    ```

    The ordering in the backward pass loop should be:
    1. Manual task skip (existing) → continue
    2. Frozen task skip (NEW) → continue
    3. Successor resolution (existing)
    4. LS calculation (existing)

    IMPORTANT: Use the same `this.toDate()` helper already in the class for date conversion. Follow the exact same skip+continue pattern as the manual task skip. Do NOT use `as unknown as` casts -- the Task type now has percent_complete, actual_start_date, actual_finish_date from Plan 06-01.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Forward pass has the frozen skip block after manual skip and before dependency resolution
    - Forward pass has the in-progress floor clamp after dependency resolution
    - Backward pass has the frozen skip block after manual skip
    - `npm run build` passes
  </verify>
  <done>Forward pass skips frozen tasks (uses actual dates) and clamps in-progress tasks. Backward pass sets LS=ES, LF=EF for frozen tasks. Slack for frozen tasks will be 0.</done>
</task>

<task type="auto">
  <name>Task 2: batchUpdateTaskCPMFields completed task branch</name>
  <files>flowplan/src/services/tasks.ts</files>
  <action>
    In `batchUpdateTaskCPMFields` in tasks.ts, add a new branch for completed tasks BEFORE the existing manual task branch (line ~239). The completed task branch must:

    1. Check `task.percent_complete === 100` (the Task type now has this field from Plan 06-01)
    2. Persist CPM fields (es, ef, ls, lf, slack, is_critical) only
    3. Do NOT sync start_date or end_date (frozen task preserves its actual dates)
    4. Use the `as never` cast pattern established in the manual task branch for supabase-js@2.91.1 compatibility

    ```typescript
    tasks.map(task => {
      // Completed task freeze: persist CPM fields only, do NOT overwrite start_date/end_date
      if (task.percent_complete === 100) {
        return supabase
          .from('tasks')
          .update({
            es: toDateStr(task.es),
            ef: toDateStr(task.ef),
            ls: toDateStr(task.ls),
            lf: toDateStr(task.lf),
            slack: task.slack ?? 0,
            is_critical: task.is_critical ?? false,
          } as never)
          .eq('id', task.id)
      }

      // Manual tasks: preserve user's start_date, sync end_date from computed EF
      if ((task as unknown as Record<string, unknown>).scheduling_mode === 'manual') {
        // ... existing manual branch ...
      }

      // Auto tasks: sync start_date/end_date with es/ef
      // ... existing auto branch ...
    })
    ```

    Also remove the `(task as unknown as Record<string, unknown>).scheduling_mode` cast on the manual branch check -- the Task type now has scheduling_mode directly. Replace with `task.scheduling_mode === 'manual'`.

    NOTE: The completed task check must come BEFORE the manual check because a manual task at 100% should still be treated as frozen (completed state takes priority over manual mode).
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run build` passes
    - batchUpdateTaskCPMFields has three branches: completed → manual → auto
    - Completed branch does NOT include start_date or end_date in the update payload
  </verify>
  <done>batchUpdateTaskCPMFields correctly handles completed tasks by persisting CPM fields without overwriting start_date/end_date. Three-branch logic: completed (freeze) → manual (end_date only) → auto (both dates).</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- `npm run build` passes
- scheduling.ts forward pass has: manual skip → frozen skip → dependency resolution → in-progress clamp → constraints → EF
- scheduling.ts backward pass has: manual skip → frozen skip → successor resolution → LS
- tasks.ts batchUpdateTaskCPMFields has: completed branch → manual branch → auto branch
</verification>

<success_criteria>
- Completed tasks (percent_complete=100) do not move when predecessors change (frozen in forward pass, LS=ES in backward pass)
- In-progress tasks (percent_complete>0) cannot move backward past actual_start_date
- batchUpdateTaskCPMFields preserves actual dates for completed tasks
- No type errors, build passes
</success_criteria>

<output>
After completion, create `.planning/phases/06-progress-tracking/06-02-SUMMARY.md`
</output>
